int getNextUserId();
bool usernameExists(const QString &username);



int LoginWindow::getNextUserId()
{
    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
        return 1;

    QTextStream in(&file);
    int lastId = 0;

    while (!in.atEnd())
    {
        QString line = in.readLine();
        QStringList parts = line.split(",");
        if (parts.size() >= 1)
            lastId = parts[0].toInt();
    }

    file.close();
    return lastId + 1;
}







bool LoginWindow::usernameExists(const QString &username)
{
    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
        return false;

    QTextStream in(&file);

    while (!in.atEnd())
    {
        QString line = in.readLine();
        QStringList parts = line.split(",");

        if (parts.size() >= 2 && parts[1] == username)
        {
            file.close();
            return true;
        }
    }

    file.close();
    return false;
}







void LoginWindow::on_registerPushButton_clicked()
{
    QString username = ui->usernameLineEdit->text();
    QString password = ui->passwordLineEdit->text();

    if (username.isEmpty() || password.isEmpty())
    {
        ui->messageLabel->setText("Fill all fields");
        return;
    }

    if (usernameExists(username))
    {
        ui->messageLabel->setText("Username already exists");
        return;
    }

    int newId = getNextUserId();

    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::Append | QIODevice::Text))
    {
        ui->messageLabel->setText("Error saving user");
        return;
    }

    QTextStream out(&file);
    out << newId << "," << username << "," << password << "\n";

    file.close();

    ui->messageLabel->setText("Register successful");
}
