#include "LoginWindow.h"
#include "ui_LoginWindow.h"
#include "customerdashboard.h"
#include <QMessageBox>
#include <QFile>
#include <QTextStream>
#include <QCoreApplication>
#include <QCryptographicHash> // for hashing

LoginWindow::LoginWindow(QWidget *parent)
    : QMainWindow(parent),
      ui(new Ui::LoginWindow)
{
    ui->setupUi(this);
}

LoginWindow::~LoginWindow()
{
    delete ui;
}

// --- Hash password ---
QString LoginWindow::hashPassword(const QString &password)
{
    QByteArray hash = QCryptographicHash::hash(password.toUtf8(), QCryptographicHash::Sha256);
    return QString(hash.toHex());
}

// --- Login ---
void LoginWindow::on_loginPushButton_clicked()
{
    QString username = ui->usernameLineEdit->text();
    QString password = hashPassword(ui->passwordLineEdit->text());

    if (username.isEmpty() || password.isEmpty()) {
        ui->messageLabel->setText("Please fill all fields.");
        return;
    }

    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::ReadOnly | QIODevice::Text)) {
        ui->messageLabel->setText("No users registered yet.");
        return;
    }

    QTextStream in(&file);
    bool found = false;

    while (!in.atEnd()) {
        QString line = in.readLine();
        QStringList parts = line.split(",");
        if (parts.size() == 2 && parts[0] == username && parts[1] == password) {
            found = true;
            break;
        }
    }

    file.close();

    if (found) {
        QMessageBox::information(this, "Login", "Login successful");
        customerdashboard *dashboard = new customerdashboard();
        dashboard->show();
        this->close();
    } else {
        ui->messageLabel->setText("Invalid username or password.");
    }
}

// --- Check if username exists ---
bool LoginWindow::isUsernameTaken(const QString &username)
{
    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
        return false; // no file yet, username not taken

    QTextStream in(&file);

    while (!in.atEnd()) {
        QString line = in.readLine();
        QStringList parts = line.split(",");
        if (parts.size() >= 1 && parts[0] == username) {
            file.close();
            return true;
        }
    }

    file.close();
    return false;
}

// --- Save new user ---
void LoginWindow::saveNewUser(const QString &username, const QString &password)
{
    QString path = QCoreApplication::applicationDirPath() + "/users.txt";
    QFile file(path);

    if (!file.open(QIODevice::Append | QIODevice::Text)) {
        QMessageBox::warning(this, "Error", "Could not save new user.");
        return;
    }

    QTextStream out(&file);
    out << username << "," << hashPassword(password) << "\n";
    file.close();
}

// --- Register ---
void LoginWindow::on_registerPushButton_clicked()
{
    QString username = ui->usernameLineEdit->text();
    QString password = ui->passwordLineEdit->text();

    if (username.isEmpty() || password.isEmpty()) {
        ui->messageLabel->setText("Please fill all fields.");
        return;
    }

    if (isUsernameTaken(username)) {
        ui->messageLabel->setText("Username already taken!");
        return;
    }

    saveNewUser(username, password);
    QMessageBox::information(this, "Register", "Registration successful!");
    ui->messageLabel->setText("");
    ui->usernameLineEdit->clear();
    ui->passwordLineEdit->clear();
}





#ifndef LOGINWINDOW_H
#define LOGINWINDOW_H

#include <QMainWindow>

namespace Ui {
class LoginWindow;
}

class LoginWindow : public QMainWindow
{
    Q_OBJECT

public:
    LoginWindow(QWidget *parent = nullptr);
    ~LoginWindow();

private slots:
    void on_loginPushButton_clicked();
    void on_registerPushButton_clicked();

private:
    Ui::LoginWindow *ui;

    bool isUsernameTaken(const QString &username);
    void saveNewUser(const QString &username, const QString &password);
    QString hashPassword(const QString &password); // hash password
};

#endif // LOGINWINDOW_H
