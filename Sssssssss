#include "LoginWindow.h"
#include "ui_LoginWindow.h"
#include "customerdashboard.h"
#include <QFile>
#include <QTextStream>
#include <QMessageBox>
#include <QCryptographicHash>

LoginWindow::LoginWindow(QWidget *parent)
    : QMainWindow(parent),
      ui(new Ui::LoginWindow)
{
    ui->setupUi(this);
}

LoginWindow::~LoginWindow()
{
    delete ui;
}

// تابع کمکی برای هش کردن رمز
QString hashPassword(const QString &password)
{
    QByteArray hash = QCryptographicHash::hash(password.toUtf8(), QCryptographicHash::Sha256);
    return QString(hash.toHex());
}

void LoginWindow::on_registerPushButton_clicked()
{
    QString username = ui->usernameLineEdit->text().trimmed();
    QString password = ui->passwordLineEdit->text();

    if(username.isEmpty() || password.isEmpty())
    {
        QMessageBox::warning(this, "Register", "Please fill all fields.");
        return;
    }

    QString path = "users.txt";
    QFile file(path);
    if (!file.open(QIODevice::ReadWrite | QIODevice::Text))
    {
        QMessageBox::warning(this, "Error", "Cannot open users file.");
        return;
    }

    QTextStream in(&file);
    int maxId = 0;
    bool exists = false;

    // بررسی اینکه آیا کاربر قبلا ثبت شده
    while (!in.atEnd())
    {
        QString line = in.readLine();
        QStringList parts = line.split(",");
        if(parts.size() < 3) continue;

        int id = parts[0].toInt();
        if(id > maxId) maxId = id;

        if(parts[1] == username)
        {
            exists = true;
            break;
        }
    }

    if(exists)
    {
        QMessageBox::warning(this, "Register", "Username already exists.");
        file.close();
        return;
    }

    // اضافه کردن کاربر جدید
    int newId = maxId + 1;
    QString hashed = hashPassword(password);

    QTextStream out(&file);
    out << newId << "," << username << "," << hashed << "\n";
    file.close();

    QMessageBox::information(this, "Register", "Registration successful!\nYour ID: " + QString::number(newId));
}

void LoginWindow::on_loginPushButton_clicked()
{
    QString username = ui->usernameLineEdit->text().trimmed();
    QString password = ui->passwordLineEdit->text();

    if(username.isEmpty() || password.isEmpty())
    {
        QMessageBox::warning(this, "Login", "Please fill all fields.");
        return;
    }

    QString path = "users.txt";
    QFile file(path);
    if (!file.open(QIODevice::ReadOnly | QIODevice::Text))
    {
        QMessageBox::warning(this, "Error", "Cannot open users file.");
        return;
    }

    QString hashed = hashPassword(password);
    bool found = false;
    int userId = -1;

    QTextStream in(&file);
    while(!in.atEnd())
    {
        QString line = in.readLine();
        QStringList parts = line.split(",");
        if(parts.size() < 3) continue;

        if(parts[1] == username && parts[2] == hashed)
        {
            found = true;
            userId = parts[0].toInt();
            break;
        }
    }

    file.close();

    if(found)
    {
        currentUserId = QString::number(userId);
        QMessageBox::information(this, "Login", "Login successful!");
        customerdashboard *dashboard = new customerdashboard();
        dashboard->show();
        this->close();
    }
    else
    {
        QMessageBox::warning(this, "Login", "Invalid username or password.");
    }
}




#ifndef LOGINWINDOW_H
#define LOGINWINDOW_H

#include <QMainWindow>

namespace Ui {
class LoginWindow;
}

class LoginWindow : public QMainWindow
{
    Q_OBJECT

public:
    explicit LoginWindow(QWidget *parent = nullptr);
    ~LoginWindow();

private slots:
    void on_loginPushButton_clicked();
    void on_registerPushButton_clicked();

private:
    Ui::LoginWindow *ui;
    QString currentUserId; // ID کاربر بعد از ورود
};

#endif // LOGINWINDOW_H
