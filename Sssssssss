#ifndef RESERVATION_H
#define RESERVATION_H

#include <QString>
#include <QDate>

class Reservation
{
public:
    QString id;
    QString username;
    QString carId;

    QDate startDate;
    QDate endDate;

    QString status;        // Pending, Approved, Rejected, Rented, Finished
    QString paymentStatus; // Unpaid, Paid

    bool extensionRequested;

    Reservation();

    QString toFileString() const;
    static Reservation fromFileString(QString line);
};

#endif






#include "Reservation.h"

Reservation::Reservation()
{
    extensionRequested = false;
}

QString Reservation::toFileString() const
{
    return id + "," +
           username + "," +
           carId + "," +
           startDate.toString("yyyy-MM-dd") + "," +
           endDate.toString("yyyy-MM-dd") + "," +
           status + "," +
           paymentStatus + "," +
           (extensionRequested ? "1" : "0");
}

Reservation Reservation::fromFileString(QString line)
{
    Reservation r;
    QStringList parts = line.split(",");

    if(parts.size() >= 8)
    {
        r.id = parts[0];
        r.username = parts[1];
        r.carId = parts[2];
        r.startDate = QDate::fromString(parts[3], "yyyy-MM-dd");
        r.endDate = QDate::fromString(parts[4], "yyyy-MM-dd");
        r.status = parts[5];
        r.paymentStatus = parts[6];
        r.extensionRequested = (parts[7] == "1");
    }

    return r;
}








bool CarManager::isCarAvailable(QString carId)
{
    loadCars();

    for(const Car &c : cars)
    {
        if(c.id == carId)
        {
            return (c.status == "Available");
        }
    }

    return false;
}








bool ReservationManager::createReservation(QString username, QString carId, QDate start, QDate end)
{
    if(!carManager->isCarAvailable(carId))
        return false;

    Reservation r;
    r.id = QString::number(QDateTime::currentSecsSinceEpoch());
    r.username = username;
    r.carId = carId;
    r.startDate = start;
    r.endDate = end;
    r.status = "Pending";
    r.paymentStatus = "Unpaid";
    r.extensionRequested = false;

    reservations.append(r);
    saveReservations();

    carManager->changeCarStatus(carId, "Reserved");

    return true;
}







bool ReservationManager::payReservation(QString reservationId)
{
    for(Reservation &r : reservations)
    {
        if(r.id == reservationId && r.paymentStatus == "Unpaid")
        {
            r.paymentStatus = "Paid";

            if(r.status == "Approved")
                r.status = "Rented";

            saveReservations();

            carManager->changeCarStatus(r.carId, "Rented");

            return true;
        }
    }

    return false;
}bool ReservationManager::payReservation(QString reservationId)
{
    for(Reservation &r : reservations)
    {
        if(r.id == reservationId && r.paymentStatus == "Unpaid")
        {
            r.paymentStatus = "Paid";

            if(r.status == "Approved")
                r.status = "Rented";

            saveReservations();

            carManager->changeCarStatus(r.carId, "Rented");

            return true;
        }
    }

    return false;
}









bool ReservationManager::requestExtension(QString reservationId)
{
    for(Reservation &r : reservations)
    {
        if(r.id == reservationId && r.status == "Rented")
        {
            r.extensionRequested = true;
            saveReservations();
            return true;
        }
    }

    return false;
}








QString ext = r.extensionRequested ? "Yes" : "No";

ui->table->setItem(row, 6, new QTableWidgetItem(ext));
